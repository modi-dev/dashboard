<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetes Pods - Server Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        .card-header { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .footer { margin-top: auto; }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-server me-2"></i>Server Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/servers.html">
                            <i class="fas fa-server me-1"></i>Servers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/pods.html">
                            <i class="fas fa-cube me-1"></i>Pods
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1><i class="fas fa-cube me-2"></i>Kubernetes Pods</h1>
                <p class="text-muted">Информация о подах и их версиях</p>
            </div>
        </div>

        <!-- Pods Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-cube fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">Всего подов</h5>
                        <h3 class="text-primary" id="totalPods">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-tag fa-2x text-info mb-2"></i>
                        <h5 class="card-title">Namespace</h5>
                        <h6 class="text-info" id="namespace">-</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-success mb-2"></i>
                        <h5 class="card-title">Последнее обновление</h5>
                        <h6 class="text-success" id="lastUpdate">-</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pods List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Список подов</h5>
                        <div>
                            <a href="/api/version/export/csv" class="btn btn-sm btn-outline-success me-2" title="Экспорт в CSV">
                                <i class="fas fa-file-csv me-1"></i>Экспорт CSV
                            </a>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshPods()">
                                <i class="fas fa-sync-alt me-1"></i>Обновить
                            </button>
                            <span class="badge bg-primary ms-2" id="podCount">0 подов</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="podsEmpty" class="text-center text-muted py-4" style="display: none;">
                            <i class="fas fa-cube fa-3x mb-3"></i>
                            <p>Нет доступных подов</p>
                            <p class="small">Убедитесь, что Kubernetes настроен и поды запущены</p>
                        </div>
                        <div id="podsTable" class="table-responsive" style="display: none;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Версия</th>
                                        <th>Порт</th>
                                        <th>CPU Request</th>
                                        <th>Memory Request</th>
                                        <th>MS Branch</th>
                                        <th>Config Branch</th>
                                        <th>GC Options</th>
                                        <th>Дата создания</th>
                                    </tr>
                                </thead>
                                <tbody id="podsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Information -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>API Information</h5>
                    </div>
                    <div class="card-body">
                        <p>Данные о подах получаются через Kubernetes API. Для получения JSON данных используйте:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>API Endpoints:</h6>
                                <ul class="list-unstyled">
                                    <li><code>GET /api/version/pods</code> - Список подов</li>
                                    <li><code>GET /api/version/info</code> - Общая информация</li>
                                    <li><code>GET /actuator/health</code> - Health check</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Пример запроса:</h6>
                                <pre class="bg-light p-2"><code>curl http://localhost:3001/api/version/pods</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer bg-light text-center py-3 mt-auto">
        <div class="container">
            <span class="text-muted">Server Dashboard v1.0.0 | 
                <a href="/actuator/health" target="_blank">Health</a> | 
                <a href="/actuator/metrics" target="_blank">Metrics</a>
            </span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPods();
            updateLastUpdateTime();
        });

        // Load pods data
        function loadPods() {
            fetch('/api/version/pods')
                .then(response => response.json())
                .then(data => {
                    updatePodsDisplay(data);
                    updateLastUpdateTime();
                })
                .catch(error => {
                    console.error('Error loading pods:', error);
                    showNotification('Ошибка загрузки подов', 'error');
                });
        }

        // Refresh pods
        function refreshPods() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            
            loadPods();
            
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 1000);
        }

        // Update pods display
        function updatePodsDisplay(pods) {
            const totalPods = pods.length;
            document.getElementById('totalPods').textContent = totalPods;
            document.getElementById('podCount').textContent = totalPods + ' ' + (totalPods === 1 ? 'под' : totalPods < 5 ? 'пода' : 'подов');

            // Get namespace from Kubernetes info
            fetch('/api/version/info')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch info');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.namespace) {
                        document.getElementById('namespace').textContent = data.namespace;
                    }
                })
                .catch(error => {
                    console.error('Error loading namespace:', error);
                    document.getElementById('namespace').textContent = 'N/A';
                });

            if (totalPods === 0) {
                document.getElementById('podsEmpty').style.display = 'block';
                document.getElementById('podsTable').style.display = 'none';
            } else {
                document.getElementById('podsEmpty').style.display = 'none';
                document.getElementById('podsTable').style.display = 'block';
                
                const tbody = document.getElementById('podsTableBody');
                tbody.innerHTML = '';
                
                pods.forEach(pod => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${pod.name || '-'}</strong></td>
                        <td><span class="badge bg-info">${pod.version || '-'}</span></td>
                        <td><span class="badge bg-secondary">${pod.port || '-'}</span></td>
                        <td><code>${pod.cpuRequest || '-'}</code></td>
                        <td><code>${pod.memoryRequest || '-'}</code></td>
                        <td>${pod.msBranch || '-'}</td>
                        <td>${pod.configBranch || '-'}</td>
                        <td><small>${pod.gcOptions || '-'}</small></td>
                        <td>${pod.creationDate ? new Date(pod.creationDate).toLocaleString('ru-RU') : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ru-RU');
        }

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            loadPods();
        }, 30000);
    </script>
</body>
</html>
